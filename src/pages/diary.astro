---
import { siteConfig } from "../config";
import { getDiaryList, getDiaryStats } from "../data/diary";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// æ£€æŸ¥æ—¥è®°é¡µé¢æ˜¯å¦å¯ç”¨
if (!siteConfig.featurePages.diary) {
	return Astro.redirect("/404/");
}

// è·å–æ—¥è®°æ•°æ®
const moments = getDiaryList();
const diaryStats = getDiaryStats();

// æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
function formatTime(dateString: string): string {
	var TG = 8;
	if (siteConfig.timeZone >= -12 && siteConfig.timeZone <= 12)
		TG = siteConfig.timeZone;
	const timeGap = TG;

	// const lang = siteConfig.lang;
	const now = new Date();
	const date = new Date(dateString);
	const diffInMinutes = Math.floor(
		(now.getTime() + timeGap * 60 * 60 * 1000 - date.getTime()) / (1000 * 60),
	);

	if (diffInMinutes < 60) {
		return `${diffInMinutes}${i18n(I18nKey.diaryMinutesAgo)}`;
	}
	if (diffInMinutes < 1440) {
		// 24å°æ—¶
		const hours = Math.floor(diffInMinutes / 60);
		return `${hours}${i18n(I18nKey.diaryHoursAgo)}`;
	}
	const days = Math.floor(diffInMinutes / 1440);
	return `${days}${i18n(I18nKey.diaryDaysAgo)}`;
}

// å¤„ç†æ—¥è®°å†…å®¹ï¼šè¯†åˆ«URLã€iframeã€å›¾ç‰‡ç­‰
function processDiaryContent(content: string): {
	text: string;
	images: string[];
	iframes: string[];
} {
	const images: string[] = [];
	const iframes: string[] = [];
	let processedText = content;

	// å…ˆæå– iframe æ ‡ç­¾
	const iframeRegex = /<iframe[^>]*>.*?<\/iframe>/gi;
	const iframeMatches = processedText.match(iframeRegex);
	if (iframeMatches) {
		iframeMatches.forEach((iframe) => {
			iframes.push(iframe);
			processedText = processedText.replace(iframe, `\n__IFRAME_PLACEHOLDER_${iframes.length - 1}__\n`);
		});
	}

	// æå–å›¾ç‰‡å’Œè§†é¢‘URLï¼ˆæ’é™¤å·²ç»æ˜¯iframeä¸­çš„ï¼‰
	const mediaUrlRegex = /(https?:\/\/[^\s<>"']+\.(jpg|jpeg|png|gif|webp|svg|mp4|mov|avi|webm))/gi;
	const mediaMatches = processedText.match(mediaUrlRegex);
	if (mediaMatches) {
		mediaMatches.forEach((url) => {
			// æ’é™¤spotifyç­‰åµŒå…¥æœåŠ¡çš„URL
			if (!url.includes('spotify') && !url.includes('youtube') && !url.includes('bilibili')) {
				if (!images.includes(url)) {
					images.push(url);
					processedText = processedText.replace(url, `\n__IMAGE_PLACEHOLDER_${images.length - 1}__\n`);
				}
			}
		});
	}

	// å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>ï¼ˆä½†ä¿ç•™å ä½ç¬¦å‘¨å›´çš„æ¢è¡Œï¼‰
	processedText = processedText.replace(/\n/g, '<br>');

	// å°†æ™®é€šURLè½¬æ¢ä¸ºé“¾æ¥ï¼ˆæ’é™¤å·²ç»æ˜¯å›¾ç‰‡/è§†é¢‘çš„URLå’Œå ä½ç¬¦ï¼‰
	const urlRegex = /(https?:\/\/[^\s<>"']+)/gi;
	processedText = processedText.replace(urlRegex, (url) => {
		// å¦‚æœåŒ…å«å ä½ç¬¦æ ‡è®°ï¼Œè·³è¿‡
		if (url.includes('__PLACEHOLDER__')) return url;
		// å¦‚æœæ˜¯åª’ä½“æ–‡ä»¶URLï¼Œè·³è¿‡ï¼ˆå·²ç»å•ç‹¬å¤„ç†ï¼‰
		if (/\.(jpg|jpeg|png|gif|webp|svg|mp4|mov|avi|webm)/i.test(url)) return url;
		// æ’é™¤åµŒå…¥æœåŠ¡çš„URL
		if (url.includes('spotify') || url.includes('youtube') || url.includes('bilibili')) return url;
		return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="diary-link text-[var(--primary)] hover:underline break-all">${url}</a>`;
	});

	return {
		text: processedText,
		images,
		iframes,
	};
}
---

<MainGridLayout title={i18n(I18nKey.diary)} description="å³åˆ»çŸ­æ–‡">
	<!-- å¼•å…¥å³ä¾§è¾¹æ å¸ƒå±€ç®¡ç†å™¨ -->
  <script>
    import('../scripts/right-sidebar-layout.js');
  </script>
	<div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
		<div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
		<div class="relative max-w-4xl w-full px-2 md:px-0">
				<!-- é¡µé¢å¤´éƒ¨ -->
				<div class="moments-header mb-6">
					<div class="header-content">
						<div class="header-info">
							<h1 class="moments-title text-xl md:text-2xl lg:text-3xl font-bold text-90 mb-1">{i18n(I18nKey.diary)}</h1>
							<p class="moments-subtitle text-sm md:text-base lg:text-lg text-75">{i18n(I18nKey.diarySubtitle)}</p>
						</div>
						<div class="header-stats">
							<div class="stat-item text-center">
								<span class="stat-number text-lg md:text-xl lg:text-2xl font-bold text-[var(--primary)]">{diaryStats.total}</span>
								<span class="stat-label text-xs md:text-sm lg:text-base text-75">{i18n(I18nKey.diaryCount)}</span>
							</div>
						</div>
					</div>
				</div>

				<!-- çŸ­æ–‡åˆ—è¡¨ -->
				<div class="moments-timeline">
					<div class="timeline-list space-y-4">
					{moments.map((moment, index) => {
						const processed = processDiaryContent(moment.content);
						// åˆå¹¶é…ç½®çš„å›¾ç‰‡å’Œä»å†…å®¹ä¸­æå–çš„å›¾ç‰‡
						const allImages = [...(moment.images || []), ...processed.images];
						
						// å¤„ç†æ–‡æœ¬ï¼Œæ›¿æ¢å ä½ç¬¦
						let displayText = processed.text;
						
						// æ›¿æ¢ iframe å ä½ç¬¦ä¸ºç©ºï¼ˆiframe ä¼šå•ç‹¬æ¸²æŸ“ï¼‰
						processed.iframes.forEach((iframe, idx) => {
							displayText = displayText.replace(`<br>__IFRAME_PLACEHOLDER_${idx}__<br>`, '');
							displayText = displayText.replace(`__IFRAME_PLACEHOLDER_${idx}__`, '');
						});
						
						// æ›¿æ¢å›¾ç‰‡å ä½ç¬¦ä¸ºç©ºï¼ˆå›¾ç‰‡ä¼šå•ç‹¬æ¸²æŸ“ï¼‰
						processed.images.forEach((img, idx) => {
							displayText = displayText.replace(`<br>__IMAGE_PLACEHOLDER_${idx}__<br>`, '');
							displayText = displayText.replace(`__IMAGE_PLACEHOLDER_${idx}__`, '');
						});
						
						return (
						<div class="moment-item card-base-daily p-4 md:p-6 lg:p-8 hover:shadow-lg transition-all">
								<div class="moment-content">
									<!-- æ¸²æŸ“æ–‡æœ¬å†…å®¹ï¼ˆåŒ…å«æ¢è¡Œå’Œé“¾æ¥ï¼‰ -->
									<div class="moment-text text-sm md:text-base lg:text-lg text-90 leading-relaxed mb-3 md:mb-4" set:html={displayText}></div>
									
									<!-- æ¸²æŸ“ iframe -->
									{processed.iframes.length > 0 && processed.iframes.map((iframe, iframeIndex) => (
										<div class="diary-iframe-wrapper mb-3 md:mb-4" set:html={iframe} />
									))}
									
									{/* æ¸²æŸ“å›¾ç‰‡å’Œè§†é¢‘ */}
									{allImages.length > 0 && (
										<div class="diary-images grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-3 lg:gap-4 mb-3 md:mb-4">
											{allImages.map((image, _index) => {
												// åˆ¤æ–­æ˜¯å¦æ˜¯è§†é¢‘
												const isVideo = /\.(mp4|mov|avi|webm)$/i.test(image);
												return (
													<div class="image-item relative rounded-md overflow-hidden aspect-square cursor-pointer hover:scale-105 transition-transform">
														{isVideo ? (
															<video 
																src={image} 
																controls
																class="w-full h-full object-cover"
																preload="metadata"
															/>
														) : (
															<a href="javascript:void(0)" data-src={image} data-fancybox={`gallery-${index}-${_index}`} class="block w-full h-full">
																<img 
																	src={image} 
																	alt="diary moment image"
																	class="w-full h-full object-cover"
																	loading="lazy"
																/>
															</a>
														)}
													</div>
												);
											})}
										</div>
									)}
								</div>
								
								<hr class="moment-divider border-t border-[var(--line-divider)] my-3 md:my-4" />
								
								<div class="moment-footer flex justify-between items-center">
									<div class="moment-time flex items-center gap-1.5 text-75 text-xs md:text-sm lg:text-base">
										<i class="time-icon text-xs md:text-sm">ğŸ•</i>
										<time datetime={moment.date}>
											{formatTime(moment.date)}
										</time>
									</div>
									
								</div>
							</div>
						);
					})}
					</div>
				</div>

				<!-- åº•éƒ¨æç¤º -->
				<div class="moments-tips text-center mt-6 md:mt-8 lg:mt-10 text-75 text-xs md:text-sm lg:text-base italic">
					{i18n(I18nKey.diaryTips)}
				</div>
			</div>
		</div>
	</div>
</MainGridLayout>

<style>
	.card-base-daily {
		@apply rounded-[var(--radius-large)] overflow-hidden bg-[var(--card-bg)];
		border: 1px solid var(--line-divider);
		transition: all 0.3s ease;
	}
	
	.moments-header {
		padding: 1rem;
		border-radius: 8px;
		background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark, var(--primary)) 100%);
		color: white;
		position: relative;
		overflow: hidden;
	}
	
	.header-content {
		display: flex;
		justify-content: space-between;
		align-items: center;
		position: relative;
		z-index: 1;
	}
	
	.moments-title {
		color: white;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
	}
	
	.moments-subtitle {
		color: rgba(255, 255, 255, 0.9);
	}
	
	.stat-number {
		color: white;
	}
	
	.stat-label {
		color: rgba(255, 255, 255, 0.8);
	}
	
	.image-item img {
		transition: transform 0.3s ease;
	}
	
	.image-item:hover img {
		transform: scale(1.05);
	}
	
	.action-btn {
		background: none;
		border: none;
		cursor: pointer;
		color: var(--text-muted);
	}
	
	.action-btn:hover {
		color: var(--primary);
	}
	
	/* å“åº”å¼è®¾è®¡ */
	/* æ‰‹æœºç«¯ (å°äº640px) */
	@media (max-width: 640px) {
		.moments-header {
			padding: 0.75rem;
		}
		
		.header-content {
			flex-direction: column;
			text-align: center;
			gap: 0.75rem;
		}
		
		.diary-images {
			grid-template-columns: repeat(2, 1fr);
		}
		
		.moment-footer {
			flex-direction: column;
			align-items: flex-start;
			gap: 0.5rem;
		}
	}
	
	/* å¹³æ¿ç«–å± (641px - 900px) - ä¼˜åŒ–æ˜¾ç¤º */
	@media (min-width: 641px) and (max-width: 900px) {
		.moments-header {
			padding: 1.25rem;
		}
		
		.header-content {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		
		.moment-item {
			padding: 1.5rem;
		}
		
		.diary-images {
			grid-template-columns: repeat(3, 1fr);
			gap: 0.75rem;
			max-width: 500px;
		}
		
	.moment-text {
		font-size: 1rem;
		line-height: 1.8;
		word-wrap: break-word;
		word-break: break-word;
	}
	
	.moment-text :global(br) {
		display: block;
		margin: 0.5em 0;
		content: "";
	}
	
	.moment-text :global(.diary-link) {
		color: var(--primary);
		text-decoration: underline;
		word-break: break-all;
	}
	
	.moment-text :global(.diary-link:hover) {
		opacity: 0.8;
	}
	
	.diary-iframe-wrapper {
		width: 100%;
		max-width: 100%;
		margin: 1rem 0;
	}
	
	.diary-iframe-wrapper :global(iframe) {
		width: 100%;
		border-radius: 12px;
	}
		
		.moment-footer {
			margin-top: 1rem;
		}
	}
	
	/* å¹³æ¿æ¨ªå±å’Œæ¡Œé¢ç«¯ (å¤§äº900px) */
	@media (min-width: 901px) {
		.moments-header {
			padding: 1.5rem;
		}
		
		.moment-item {
			padding: 2rem;
		}
		
		.diary-images {
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			max-width: 600px;
			gap: 1rem;
		}
		
		.moment-text {
			font-size: 1.1rem;
			line-height: 1.8;
		}
	}
	
	/* ä¼˜åŒ–å°å±å¹•æ˜¾ç¤º */
	@media (max-width: 480px) {
		.moment-item {
			border-radius: 8px;
		}
		
		.moments-header {
			border-radius: 6px;
		}
	}
</style>


